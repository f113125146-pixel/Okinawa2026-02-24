<!DOCTYPE html>
<html lang="zh-TW">
<head>
<!-- iOS 全螢幕設定 -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Okinawa2026">

<!-- Android 全螢幕設定 -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#ffffff">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>沖繩之旅 2026</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'ocean': '#0ea5e9', 
                        'deep-sea': '#0369a1',
                        'sand': '#f8fafc',
                        'sunset': '#f97316',
                        'monorail': '#ef4444',
                        'bus': '#3b82f6',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace'],
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f1f5f9;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 100px;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }

        .phrase-group { display: none; animation: fadeIn 0.2s ease-out; }
        .phrase-group.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Monorail Line */
        .rail-line {
            position: absolute; left: 23px; top: 20px; bottom: 20px; width: 4px;
            background-color: #e2e8f0; z-index: 0;
        }

        /* Bus Viz */
        .bus-line {
            position: absolute; left: 19px; top: 15px; bottom: 15px; width: 2px;
            background-color: #bfdbfe; border-left: 2px dashed #bfdbfe; z-index: 0;
        }
    </style>
</head>
<body class="text-slate-800 bg-slate-100">

    <!-- Header -->
    <header class="fixed top-0 w-full bg-white/90 backdrop-blur-md shadow-sm z-50 transition-all duration-300">
        <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
            <div onclick="window.scrollTo(0,0)">
                <h1 class="text-xl font-bold text-deep-sea tracking-wide">OKINAWA <span class="text-ocean text-sm font-normal">2026</span></h1>
                <p class="text-xs text-slate-500 font-mono">2/24 (Tue) - 2/28 (Sat)</p>
            </div>
            <div class="text-right">
                <button onclick="switchTab('tools')" class="text-slate-400 hover:text-ocean transition-colors">
                    <i class="fas fa-th-large"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-md mx-auto pt-20 px-4">

        <!-- 1. PLAN SECTION -->
        <section id="plan" class="tab-content active">
            
            <!-- Hero Countdown -->
            <div class="bg-gradient-to-br from-deep-sea to-ocean rounded-2xl p-6 text-white shadow-lg mb-6 relative overflow-hidden">
                <i class="fas fa-plane-departure absolute -right-4 -bottom-4 text-9xl text-white/10 rotate-12"></i>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-1 opacity-80">
                        <i class="far fa-clock"></i>
                        <span class="text-xs font-mono uppercase tracking-wider">Countdown</span>
                    </div>
                    <h2 class="text-4xl font-bold font-mono tracking-tight mb-1" id="countdown-text">...</h2>
                    <p class="text-sm font-medium text-blue-100">準備好迎接沖繩的陽光了嗎？</p>
                </div>
            </div>

            <!-- Flight Card -->
            <h3 class="font-bold text-slate-700 mb-3 flex items-center"><i class="fas fa-ticket-alt text-ocean mr-2"></i> 航班資訊</h3>
            <div class="bg-white rounded-2xl shadow-card overflow-hidden mb-6">
                <!-- Outbound -->
                <div class="p-5">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-2">
                            <span class="bg-ocean text-white text-[10px] px-2 py-1 rounded font-bold uppercase tracking-wide">Departure</span>
                            <span class="text-xs font-bold text-slate-600">2/24 (二)</span>
                        </div>
                        <span class="font-mono font-bold text-slate-800"><i class="fas fa-plane text-slate-300 mr-1"></i> IT288</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="text-center">
                            <div class="text-3xl font-bold font-mono text-slate-800">KHH</div>
                            <div class="text-xs text-slate-500">高雄</div>
                            <div class="text-sm font-bold text-ocean mt-1">09:45</div>
                        </div>
                        <div class="flex-1 px-4 flex flex-col items-center">
                            <span class="text-[10px] text-slate-400 mb-1">1h 45m</span>
                            <div class="w-full h-px bg-slate-300 relative">
                                <i class="fas fa-plane absolute top-1/2 left-1/2 -translate-y-1/2 -translate-x-1/2 bg-white px-1 text-slate-400 text-xs"></i>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold font-mono text-slate-800">OKA</div>
                            <div class="text-xs text-slate-500">那霸</div>
                            <div class="text-sm font-bold text-ocean mt-1">12:30</div>
                        </div>
                    </div>
                </div>
                
                <!-- Divider -->
                <div class="relative h-4 bg-slate-50">
                    <div class="absolute w-4 h-4 bg-slate-100 rounded-full -left-2 top-0"></div>
                    <div class="absolute w-4 h-4 bg-slate-100 rounded-full -right-2 top-0"></div>
                    <div class="absolute top-1/2 left-2 right-2 border-t-2 border-dashed border-slate-300"></div>
                </div>

                <!-- Inbound -->
                <div class="p-5 bg-slate-50">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-2">
                            <span class="bg-sunset text-white text-[10px] px-2 py-1 rounded font-bold uppercase tracking-wide">Return</span>
                            <span class="text-xs font-bold text-slate-600">2/28 (六)</span>
                        </div>
                        <span class="font-mono font-bold text-slate-800"><i class="fas fa-plane text-slate-300 mr-1"></i> IT289</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="text-center">
                            <div class="text-3xl font-bold font-mono text-slate-800">OKA</div>
                            <div class="text-xs text-slate-500">那霸</div>
                            <div class="text-sm font-bold text-sunset mt-1">13:30</div>
                        </div>
                        <div class="flex-1 px-4 flex flex-col items-center">
                            <span class="text-[10px] text-slate-400 mb-1">1h 54m</span>
                            <div class="w-full h-px bg-slate-300 relative">
                                <i class="fas fa-plane fa-flip-horizontal absolute top-1/2 left-1/2 -translate-y-1/2 -translate-x-1/2 bg-slate-50 px-1 text-slate-400 text-xs"></i>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold font-mono text-slate-800">KHH</div>
                            <div class="text-xs text-slate-500">高雄</div>
                            <div class="text-sm font-bold text-sunset mt-1">14:24</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hotel Info -->
            <h3 class="font-bold text-slate-700 mb-3 flex items-center"><i class="fas fa-hotel text-ocean mr-2"></i> 住宿資訊</h3>
            <div class="bg-white rounded-2xl shadow-card p-5 mb-6 border-l-4 border-sunset relative">
                <div class="mb-3">
                    <h2 class="font-bold text-lg text-slate-800 leading-tight">Hotel Torifito Naha Asahibashi</h2>
                    <p class="text-xs text-slate-500">沖繩那霸旭橋托里菲托酒店</p>
                </div>

                <!-- Taxi Card -->
                <div class="bg-slate-100 rounded-lg p-3 mb-4 border border-slate-200">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wide"><i class="fas fa-taxi mr-1"></i> Show to Driver</span>
                        <button class="text-xs text-ocean font-bold" onclick="copyAddress()">複製</button>
                    </div>
                    <p class="font-bold text-lg text-slate-800 mb-1">ホテル・トリフィート那覇旭橋</p>
                    <p class="text-xs text-slate-600 mb-2">〒900-0021 沖縄県那覇市泉崎1-11-19</p>
                    <div class="flex gap-3 text-xs font-mono text-slate-600">
                        <span><i class="fas fa-phone-alt mr-1"></i> 098-860-6300</span>
                        <span><i class="fas fa-map-marked-alt mr-1"></i> MC: 33 126 597*36</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <div class="bg-orange-50 text-orange-800 px-3 py-2 rounded-lg text-xs font-bold border border-orange-100 col-span-2">
                        <i class="fas fa-bed mr-2"></i> 3人高級雙床房 (Superior Twin)
                    </div>
                    <div class="bg-slate-50 text-slate-600 px-3 py-2 rounded-lg text-xs border border-slate-100 flex items-center justify-between">
                        <span>Check-in</span> <span class="font-mono font-bold">15:00</span>
                    </div>
                    <div class="bg-slate-50 text-slate-600 px-3 py-2 rounded-lg text-xs border border-slate-100 flex items-center justify-between">
                        <span>Check-out</span> <span class="font-mono font-bold">11:00</span>
                    </div>
                </div>

                <div class="flex gap-2">
                    <a href="https://www.google.com/maps/search/?api=1&query=Hotel+Torifito+Naha+Asahibashi" target="_blank" class="flex-1 bg-slate-800 text-white text-center py-2 rounded-lg text-xs font-bold shadow-sm hover:bg-slate-700"><i class="fas fa-location-arrow mr-1"></i> 導航</a>
                    <a href="tel:+81988606300" class="flex-1 bg-white text-slate-700 border border-slate-200 text-center py-2 rounded-lg text-xs font-bold shadow-sm hover:bg-slate-50"><i class="fas fa-phone mr-1"></i> 通話</a>
                </div>
            </div>

            <!-- Itinerary -->
            <div id="itinerary-container" class="space-y-6 pb-6"></div>
        </section>

        <!-- 2. GUIDE SECTION -->
        <section id="guide" class="tab-content">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-deep-sea">深度導覽</h2>
                <span class="text-xs font-mono bg-white border border-slate-200 px-2 py-1 rounded text-slate-500">All Spots</span>
            </div>
            
            <div class="sticky top-16 z-20 bg-slate-100/95 backdrop-blur py-2 -mx-4 px-4 border-b border-slate-200 mb-4 overflow-x-auto no-scrollbar flex gap-2">
                <button onclick="filterGuide('all')" class="guide-filter active px-4 py-1.5 rounded-full text-sm font-medium bg-deep-sea text-white shadow-sm whitespace-nowrap transition-all">全部</button>
                <button onclick="filterGuide('food')" class="guide-filter px-4 py-1.5 rounded-full text-sm font-medium bg-white text-slate-600 border border-slate-200 whitespace-nowrap transition-all">在地美食</button>
                <button onclick="filterGuide('spot')" class="guide-filter px-4 py-1.5 rounded-full text-sm font-medium bg-white text-slate-600 border border-slate-200 whitespace-nowrap transition-all">必訪景點</button>
                <button onclick="filterGuide('shop')" class="guide-filter px-4 py-1.5 rounded-full text-sm font-medium bg-white text-slate-600 border border-slate-200 whitespace-nowrap transition-all">購物血拼</button>
            </div>

            <div id="guide-container" class="space-y-4 pb-6"></div>
        </section>

        <!-- 3. TRAFFIC SECTION -->
        <section id="traffic" class="tab-content">
            <h2 class="text-2xl font-bold text-deep-sea mb-4">交通全攻略</h2>

            <!-- Monorail Full Map (Font Size Fixed) -->
            <div class="bg-white rounded-2xl p-5 shadow-card mb-6 border border-slate-100">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-700 flex items-center">
                        <span class="w-2 h-6 bg-monorail rounded-full mr-2"></span>
                        單軌電車 (Yui Rail)
                    </h3>
                    <div class="text-[10px] text-slate-400 bg-slate-50 px-2 py-1 rounded">全 19 站</div>
                </div>
                
                <div class="relative pl-2 h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                    <div class="rail-line rounded-full h-full"></div>
                    <div id="monorail-stations" class="relative z-10 space-y-0">
                        <!-- Stations injected by JS -->
                    </div>
                </div>
            </div>

            <!-- Bus Routes Customized -->
            <h3 class="font-bold text-slate-700 mb-3 ml-1"><i class="fas fa-bus text-bus mr-2"></i> 行程專屬公車卡</h3>
            <div class="space-y-4 pb-6">
                <!-- Day 2 Bus -->
                <div class="bg-white rounded-xl shadow-sm border-l-4 border-bus overflow-hidden">
                    <div class="bg-blue-50 p-3 flex justify-between items-center border-b border-blue-100">
                        <div class="font-bold text-blue-800 text-sm">Day 2 回程: 120 / 28 號</div>
                        <div class="text-[10px] bg-blue-200 text-blue-800 px-2 py-0.5 rounded-full font-bold">往那霸</div>
                    </div>
                    <div class="p-4 relative">
                        <div class="bus-line"></div>
                        <div class="space-y-6 relative z-10">
                            <div class="flex items-start">
                                <div class="w-2.5 h-2.5 rounded-full bg-bus ml-[11px] mr-4 mt-1.5 ring-4 ring-white"></div>
                                <div>
                                    <div class="font-bold text-slate-800 text-sm">桑江 (Kuwae)</div>
                                    <div class="text-xs text-slate-500">上車點 (靠近美國村入口)</div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <div class="w-2 h-2 rounded-full bg-slate-300 ml-[12px] mr-4"></div>
                                <div class="text-xs text-slate-400">行經 58 號國道 (約 60 分鐘)</div>
                            </div>
                            <div class="flex items-start">
                                <div class="w-2.5 h-2.5 rounded-full bg-bus ml-[11px] mr-4 mt-1.5 ring-4 ring-white"></div>
                                <div>
                                    <div class="font-bold text-slate-800 text-sm">那霸公車總站 (旭橋)</div>
                                    <div class="text-xs text-slate-500">終點站下車，旁邊即是飯店</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Day 3 Bus (To Okinawa World) -->
                <div class="bg-white rounded-xl shadow-sm border-l-4 border-purple-500 overflow-hidden">
                    <div class="bg-purple-50 p-3 flex justify-between items-center border-b border-purple-100">
                        <div class="font-bold text-purple-800 text-sm">Day 3 去程: 54 / 83 號</div>
                        <div class="text-[10px] bg-purple-200 text-purple-800 px-2 py-0.5 rounded-full font-bold">往玉泉洞</div>
                    </div>
                    <div class="p-4 relative">
                        <div class="bus-line border-purple-300"></div>
                        <div class="space-y-6 relative z-10">
                            <div class="flex items-start">
                                <div class="w-2.5 h-2.5 rounded-full bg-purple-500 ml-[11px] mr-4 mt-1.5 ring-4 ring-white"></div>
                                <div>
                                    <div class="font-bold text-slate-800 text-sm">那霸公車總站</div>
                                    <div class="text-xs text-slate-500">建議搭乘 08:40 班次</div>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <div class="w-2.5 h-2.5 rounded-full bg-purple-500 ml-[11px] mr-4 mt-1.5 ring-4 ring-white"></div>
                                <div>
                                    <div class="font-bold text-slate-800 text-sm">玉泉洞前</div>
                                    <div class="text-xs text-slate-500">終點站下車</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Day 3 Shuttle -->
                <div class="bg-white rounded-xl shadow-sm border-l-4 border-pink-500 overflow-hidden">
                    <div class="bg-pink-50 p-3 flex justify-between items-center border-b border-pink-100">
                        <div class="font-bold text-pink-800 text-sm">Day 3 接駁: TK02</div>
                        <div class="text-[10px] bg-pink-200 text-pink-800 px-2 py-0.5 rounded-full font-bold">購物專線</div>
                    </div>
                    <div class="p-4">
                        <div class="flex items-center justify-between text-sm font-bold text-slate-700 mb-2">
                            <span>瀨長島飯店前</span>
                            <i class="fas fa-arrow-right text-slate-300"></i>
                            <span>Ashibinaa Outlet</span>
                        </div>
                        <p class="text-xs text-slate-600 bg-slate-50 p-2 rounded">
                            <i class="fas fa-clock text-pink-500 mr-1"></i> 每小時約 1-2 班車。<br>
                            <i class="fas fa-yen-sign text-pink-500 mr-1"></i> 若錯過建議直接搭計程車 (約 ¥1500)。
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. WALLET SECTION -->
        <section id="wallet" class="tab-content">
            <h2 class="text-2xl font-bold text-deep-sea mb-4">記帳 & 匯率</h2>
            
            <!-- Exchange & Tax Tool (Internal) -->
            <div class="grid grid-cols-1 gap-3 mb-4">
                <!-- Tax Free Calc -->
                <div class="bg-slate-800 text-white p-4 rounded-xl shadow-sm flex flex-col justify-center">
                    <div class="flex justify-between items-center mb-2">
                        <div class="text-xs text-slate-400 font-bold"><i class="fas fa-shopping-bag mr-1"></i> 日本免稅計算 (10%)</div>
                        <div class="text-[10px] text-yellow-400 border border-yellow-400 px-1 rounded">滿 ¥5000 可退</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-mono text-slate-400">¥</span>
                        <input type="number" id="tax-input" placeholder="輸入含稅價格" class="flex-1 bg-slate-700 border-none rounded px-2 py-2 text-lg text-white outline-none font-mono placeholder-slate-500" oninput="calcTax()">
                    </div>
                    <div class="mt-3 pt-2 border-t border-slate-600 flex justify-between items-center">
                        <span class="text-xs text-slate-400">退稅金額</span>
                        <span class="text-sm font-bold font-mono text-white">¥<span id="refund-amount">0</span></span>
                    </div>
                    <div class="mt-1 flex justify-between items-center">
                        <span class="text-xs text-slate-400">免稅後價格</span>
                        <span class="text-lg font-bold font-mono text-yellow-400">¥<span id="tax-result">0</span></span>
                    </div>
                </div>
            </div>

            <!-- Budget Control (Fixed Clickability) -->
            <div class="bg-white rounded-2xl p-5 shadow-sm mb-4 border border-slate-100 relative">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xs font-bold text-slate-400 uppercase">總預算進度 (JPY)</h3>
                    <!-- Fixed Button: Added hover effect and increased touch target -->
                    <button onclick="toggleBudgetInput()" class="text-xs text-ocean font-bold hover:bg-blue-50 px-2 py-1 rounded transition-colors"><i class="fas fa-edit mr-1"></i>修改預算</button>
                </div>
                
                <!-- Hidden Input Area -->
                <div id="budget-input-box" class="hidden mb-3 bg-slate-50 p-2 rounded-lg flex gap-2 border border-slate-200">
                    <input type="number" id="new-budget-input" class="w-full text-sm border border-slate-300 rounded px-2 py-1 outline-none text-slate-700 font-mono" placeholder="輸入新預算">
                    <button onclick="saveNewBudget()" class="bg-ocean text-white text-xs px-3 py-1 rounded font-bold whitespace-nowrap active:scale-95 transition-transform">確定</button>
                </div>

                <div class="relative h-3 bg-slate-100 rounded-full overflow-hidden mb-2">
                    <div id="budget-bar" class="absolute top-0 left-0 h-full bg-green-400 transition-all duration-500" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-sm font-mono">
                    <span class="text-slate-500">已花: ¥<span id="total-spent-jpy">0</span></span>
                    <span class="text-slate-700 font-bold">剩餘: ¥<span id="budget-left">0</span></span>
                </div>
            </div>

            <!-- Expense Calculator (Internal) -->
            <div class="bg-white rounded-2xl shadow-sm p-4 border border-slate-100 mb-6">
                <div class="flex justify-between text-xs text-slate-400 mb-2">
                    <span>記帳金額</span>
                    <span class="flex items-center">匯率: <input type="number" id="exchange-rate" value="0.215" class="w-12 bg-transparent text-right font-bold text-slate-600 outline-none ml-1 border-b border-slate-300" step="0.001"></span>
                </div>
                <div class="flex gap-2 mb-3">
                    <input type="text" id="calc-input" placeholder="例如: 1200+580" class="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-3 font-mono text-lg outline-none text-slate-800 placeholder-slate-400">
                    <button onclick="calculateCurrency()" class="bg-ocean hover:bg-sky-400 text-white w-12 rounded-lg font-bold text-xl shadow-sm transition-colors">=</button>
                </div>
                <div id="calc-result" class="text-right text-sm font-bold text-ocean font-mono h-5 opacity-0 transition-opacity"></div>
                
                <hr class="border-slate-100 my-3">

                <h3 class="font-bold text-slate-700 mb-3 flex items-center text-sm">
                    <i class="fas fa-plus-circle text-ocean mr-2"></i> 新增消費
                </h3>
                
                <!-- Add Expense Form -->
                <div class="space-y-3">
                    <div class="flex gap-2">
                        <select id="expense-payer" class="w-1/3 bg-slate-50 border border-slate-200 rounded-lg p-2.5 text-sm outline-none focus:border-ocean text-slate-700">
                            <option value="公費">公費</option>
                            <option value="自己">自己</option>
                            <option value="爸爸">爸爸</option>
                            <option value="媽媽">媽媽</option>
                        </select>
                        <input type="text" id="expense-item" placeholder="消費項目" class="flex-1 bg-slate-50 border border-slate-200 rounded-lg p-2.5 text-sm outline-none focus:border-ocean text-slate-700">
                    </div>
                    <input type="number" id="expense-amount" placeholder="日幣金額 (¥)" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 text-sm outline-none focus:border-ocean text-slate-700 font-mono">
                    <button onclick="addExpense()" class="w-full bg-deep-sea text-white py-3 rounded-lg font-bold text-sm shadow-md active:scale-95 transition-transform flex justify-center items-center">
                        <i class="fas fa-save mr-2"></i> 儲存這筆消費
                    </button>
                </div>
            </div>

            <!-- List -->
            <div id="expense-list" class="space-y-3 pb-6"></div>
        </section>

        <!-- 5. TOOLS SECTION -->
        <section id="tools" class="tab-content">
            <h2 class="text-2xl font-bold text-deep-sea mb-4">實用工具</h2>

            <!-- Weather -->
            <div class="bg-gradient-to-br from-blue-400 to-blue-600 text-white rounded-2xl p-5 shadow-lg mb-6 relative overflow-hidden">
                <i class="fas fa-cloud-sun absolute -right-4 -top-4 text-8xl text-white/20"></i>
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold text-lg">2026年 2月預測</h3>
                            <p class="text-xs text-blue-100 mt-1"><i class="fas fa-map-marker-alt mr-1"></i> 那霸市</p>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold">21°C</div>
                            <div class="text-xs text-blue-100">Avg</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-5 gap-2 text-center text-xs">
                        <div class="bg-white/20 rounded p-1.5 backdrop-blur-sm">
                            <div class="opacity-80">2/24</div>
                            <i class="fas fa-sun my-1 text-lg text-yellow-300"></i>
                            <div class="font-bold">22°</div>
                        </div>
                        <div class="bg-white/20 rounded p-1.5 backdrop-blur-sm">
                            <div class="opacity-80">2/25</div>
                            <i class="fas fa-cloud-sun my-1 text-lg"></i>
                            <div class="font-bold">20°</div>
                        </div>
                        <div class="bg-white/20 rounded p-1.5 backdrop-blur-sm">
                            <div class="opacity-80">2/26</div>
                            <i class="fas fa-cloud my-1 text-lg"></i>
                            <div class="font-bold">19°</div>
                        </div>
                        <div class="bg-white/20 rounded p-1.5 backdrop-blur-sm">
                            <div class="opacity-80">2/27</div>
                            <i class="fas fa-sun my-1 text-lg text-yellow-300"></i>
                            <div class="font-bold">23°</div>
                        </div>
                        <div class="bg-white/20 rounded p-1.5 backdrop-blur-sm">
                            <div class="opacity-80">2/28</div>
                            <i class="fas fa-cloud-sun my-1 text-lg"></i>
                            <div class="font-bold">21°</div>
                        </div>
                    </div>
                    <div class="mt-3 pt-2 border-t border-white/20 text-[10px] text-blue-50">
                        <i class="fas fa-tshirt mr-1"></i> 建議穿搭：短袖搭配薄外套，海邊風大請帶帽子。
                    </div>
                </div>
            </div>

            <!-- Japanese Phrases (Tabs + TTS) -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden mb-6">
                <div class="bg-indigo-50 p-3 border-b border-indigo-100 flex justify-between items-center">
                    <h3 class="font-bold text-indigo-800 text-sm"><i class="fas fa-language mr-2"></i> 情境式日文 (點擊發音)</h3>
                </div>
                
                <!-- Category Tabs -->
                <div class="flex text-xs border-b border-slate-100 bg-slate-50">
                    <button onclick="switchPhraseTab('basic')" id="tab-basic" class="flex-1 py-2 font-bold text-indigo-600 border-b-2 border-indigo-500 bg-white transition-all">基本</button>
                    <button onclick="switchPhraseTab('dining')" id="tab-dining" class="flex-1 py-2 text-slate-500 border-b-2 border-transparent hover:text-slate-700 transition-all">餐廳</button>
                    <button onclick="switchPhraseTab('shopping')" id="tab-shopping" class="flex-1 py-2 text-slate-500 border-b-2 border-transparent hover:text-slate-700 transition-all">購物</button>
                    <button onclick="switchPhraseTab('traffic')" id="tab-traffic" class="flex-1 py-2 text-slate-500 border-b-2 border-transparent hover:text-slate-700 transition-all">交通</button>
                </div>

                <!-- Phrases Content -->
                <div class="bg-white min-h-[200px]">
                    <!-- Basic -->
                    <div id="phrases-basic" class="phrase-group active divide-y divide-slate-50">
                        <div class="p-3 hover:bg-slate-50 cursor-pointer active:bg-indigo-50" onclick="speakJapanese('こんにちは')">
                            <div class="flex justify-between items-center mb-1"><span class="text-xs text-slate-500 font-bold">你好</span><i class="fas fa-volume-up text-indigo-300"></i></div>
                            <div class="text-sm font-bold text-slate-800">Konnichiwa</div>
                            <div class="text-xs text-slate-400">こんにちは</div>
                        </div>
                        <div class="p-3 hover:bg-slate-50 cursor-pointer active:bg-indigo-50" onclick="speakJapanese('ありがとう')">
                            <div class="flex justify-between items-center mb-1"><span class="text-xs text-slate-500 font-bold">謝謝</span><i class="fas fa-volume-up text-indigo-300"></i></div>
                            <div class="text-sm font-bold text-slate-800">Arigatou</div>
                            <div class="text-xs text-slate-400">ありがとう</div>
                        </div>
                        <div class="p-3 hover:bg-slate-50 cursor-pointer active:bg-indigo-50" onclick="speakJapanese('すみません')">
                            <div class="flex justify-between items-center mb-1"><span class="text-xs text-slate-500 font-bold">不好意思 / 請問</span><i class="fas fa-volume-up text-indigo-300"></i></div>
                            <div class="text-sm font-bold text-slate-800">Sumimasen</div>
                            <div class="text-xs text-slate-400">すみません</div>
                        </div>
                    </div>

                    <!-- Dining -->
                    <div id="phrases-dining" class="phrase-group divide-y divide-slate-50">
                        <div class="p-3 hover:bg-slate-50 cursor-pointer active:bg-indigo-50" onclick="speakJapanese('メニューをください')">
                            <div class="flex justify-between items-center mb-1"><span class="text-xs text-slate-500 font-bold">請給我菜單</span><i class="fas fa-volume-up text-indigo-300"></i></div>
                            <div class="text-sm font-bold text-slate-800">Menyu o kudasai</div>
                            <div class="text-xs text-slate-400">メニューをください</div>
                        </div>
                        <div class="p-3 hover:bg-slate-50 cursor-pointer active:bg-indigo-50" onclick="speakJapanese('これはなんですか')">
                            <div class="flex justify-between items-center mb-1"><span class="text-xs text-slate-500 font-bold">這是什麼？</span><i class="fas fa-volume-up text-indigo-300"></i></div>
                            <div class="text-sm font-bold text-slate-800">Kore wa nan desu ka?</div>
                            <div class="text-xs text-slate-400">これは何ですか？</div>
                        </div>
                        <div class="p-3 hover:bg-slate-50 cursor-pointer active:bg-indigo-50" onclick="speakJapanese('お会計お願いします')">
                            <div class="flex justify-between items-center mb-1"><span class="text-xs text-slate-500 font-bold">我要結帳</span><i class="fas fa-volume-up text-indigo-300"></i></div>
                            <div class="text-sm font-bold text-slate-800">O-kaikei onegaishimasu</div>
                            <div class="text-xs text-slate-400">お会計お願いします</div>
                        </div>
                    </div>

                    <!-- Shopping -->
                    <div id="phrases-shopping" class="phrase-group divide-y divide-slate-50">
                        <div class="p-3 hover:bg-slate-50 cursor-pointer active:bg-indigo-50" onclick="speakJapanese('いくらですか')">
                            <div class="flex justify-between items-center mb-1"><span class="text-xs text-slate-500 font-bold">多少錢？</span><i class="fas fa-volume-up text-indigo-300"></i></div>
                            <div class="text-sm font-bold text-slate-800">Ikura desu ka?</div>
                            <div class="text-xs text-slate-400">いくらですか？</div>
                        </div>
                        <div class="p-3 hover:bg-slate-50 cursor-pointer active:bg-indigo-50" onclick="speakJapanese('免税できますか')">
                            <div class="flex justify-between items-center mb-1"><span class="text-xs text-slate-500 font-bold">可以免稅嗎？</span><i class="fas fa-volume-up text-indigo-300"></i></div>
                            <div class="text-sm font-bold text-slate-800">Men-zei dekimasu ka?</div>
                            <div class="text-xs text-slate-400">免税できますか？</div>
                        </div>
                        <div class="p-3 hover:bg-slate-50 cursor-pointer active:bg-indigo-50" onclick="speakJapanese('袋ください')">
                            <div class="flex justify-between items-center mb-1"><span class="text-xs text-slate-500 font-bold">請給我袋子</span><i class="fas fa-volume-up text-indigo-300"></i></div>
                            <div class="text-sm font-bold text-slate-800">Fukuro kudasai</div>
                            <div class="text-xs text-slate-400">袋ください</div>
                        </div>
                    </div>

                    <!-- Traffic -->
                    <div id="phrases-traffic" class="phrase-group divide-y divide-slate-50">
                        <div class="p-3 hover:bg-slate-50 cursor-pointer active:bg-indigo-50" onclick="speakJapanese('空港に行きたいです')">
                            <div class="flex justify-between items-center mb-1"><span class="text-xs text-slate-500 font-bold">我想去機場</span><i class="fas fa-volume-up text-indigo-300"></i></div>
                            <div class="text-sm font-bold text-slate-800">Ku-ko ni ikitai desu</div>
                            <div class="text-xs text-slate-400">空港に行きたいです</div>
                        </div>
                        <div class="p-3 hover:bg-slate-50 cursor-pointer active:bg-indigo-50" onclick="speakJapanese('トイレはどこですか')">
                            <div class="flex justify-between items-center mb-1"><span class="text-xs text-slate-500 font-bold">廁所在哪裡？</span><i class="fas fa-volume-up text-indigo-300"></i></div>
                            <div class="text-sm font-bold text-slate-800">Toire wa doko desu ka?</div>
                            <div class="text-xs text-slate-400">トイレはどこですか？</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Memo -->
            <div class="bg-white rounded-2xl shadow-sm p-5 mb-6 border border-slate-100">
                <h3 class="font-bold text-slate-700 mb-3"><i class="fas fa-sticky-note text-yellow-500 mr-2"></i> 備忘錄</h3>
                <textarea id="memo-area" class="w-full h-32 bg-yellow-50 border border-yellow-100 rounded-xl p-3 text-sm resize-none outline-none focus:ring-1 focus:ring-yellow-300 text-slate-700 leading-relaxed" placeholder="輸入文字 (自動儲存)..."></textarea>
            </div>

            <!-- Emergency Contacts -->
            <div class="bg-white rounded-2xl shadow-sm p-5 mb-6 border-l-4 border-red-500">
                <h3 class="font-bold text-red-600 mb-3"><i class="fas fa-exclamation-triangle mr-2"></i> 緊急聯絡</h3>
                <div class="grid grid-cols-2 gap-3">
                    <a href="tel:110" class="bg-red-50 text-red-700 p-3 rounded-lg text-center font-bold text-sm block hover:bg-red-100 border border-red-100">
                        <i class="fas fa-user-shield block mb-1 text-lg"></i> 警察 110
                    </a>
                    <a href="tel:119" class="bg-red-50 text-red-700 p-3 rounded-lg text-center font-bold text-sm block hover:bg-red-100 border border-red-100">
                        <i class="fas fa-ambulance block mb-1 text-lg"></i> 救護 119
                    </a>
                    <a href="tel:+81-80-1009-2436" class="col-span-2 bg-slate-50 text-slate-700 p-3 rounded-lg text-center border border-slate-200 text-sm block hover:bg-slate-100">
                        <div class="font-bold text-red-600">外交部旅外急難救助 (24H)</div>
                        <div class="font-mono text-xs text-slate-500 mt-1">+81-80-1009-2436</div>
                    </a>
                </div>
            </div>

            <!-- Backup -->
            <div class="bg-white rounded-2xl shadow-sm p-5 mb-6 border border-slate-100">
                <h3 class="font-bold text-slate-700 mb-3 text-sm"><i class="fas fa-database text-slate-400 mr-2"></i> 資料備份</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="exportData()" class="bg-slate-100 text-slate-600 py-2 rounded-lg text-xs font-medium hover:bg-slate-200 border border-slate-200">匯出檔案</button>
                    <label class="bg-slate-100 text-slate-600 py-2 rounded-lg text-xs font-medium hover:bg-slate-200 border border-slate-200 text-center cursor-pointer">
                        匯入還原 <input type="file" id="import-file" class="hidden" onchange="importData(this)">
                    </label>
                </div>
            </div>
        </section>

    </main>

    <!-- Navigation -->
    <nav class="fixed bottom-0 w-full bg-white/95 backdrop-blur border-t border-slate-200 pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.02)] z-50">
        <div class="flex justify-around items-center h-16 max-w-md mx-auto">
            <button onclick="switchTab('plan')" class="nav-btn active flex-1 flex flex-col items-center justify-center h-full text-slate-400 hover:text-deep-sea transition-colors" data-target="plan">
                <i class="fas fa-calendar-alt text-lg mb-1"></i><span class="text-[10px] font-medium">行程</span>
            </button>
            <button onclick="switchTab('guide')" class="nav-btn flex-1 flex flex-col items-center justify-center h-full text-slate-400 hover:text-deep-sea transition-colors" data-target="guide">
                <i class="fas fa-book-open text-lg mb-1"></i><span class="text-[10px] font-medium">導覽</span>
            </button>
            <button onclick="switchTab('traffic')" class="nav-btn flex-1 flex flex-col items-center justify-center h-full text-slate-400 hover:text-deep-sea transition-colors" data-target="traffic">
                <i class="fas fa-train text-lg mb-1"></i><span class="text-[10px] font-medium">交通</span>
            </button>
            <button onclick="switchTab('wallet')" class="nav-btn flex-1 flex flex-col items-center justify-center h-full text-slate-400 hover:text-deep-sea transition-colors" data-target="wallet">
                <i class="fas fa-wallet text-lg mb-1"></i><span class="text-[10px] font-medium">記帳</span>
            </button>
            <button onclick="switchTab('tools')" class="nav-btn flex-1 flex flex-col items-center justify-center h-full text-slate-400 hover:text-deep-sea transition-colors" data-target="tools">
                <i class="fas fa-th-large text-lg mb-1"></i><span class="text-[10px] font-medium">工具</span>
            </button>
        </div>
    </nav>

    <div id="toast" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-slate-800/90 text-white px-5 py-2.5 rounded-full text-sm shadow-xl opacity-0 pointer-events-none transition-all duration-300 z-50 flex items-center gap-2">
        <i class="fas fa-check"></i> <span id="toast-msg">已儲存</span>
    </div>

    <!-- Script -->
    <script>
        // --- Monorail Stations Data (Consistent Font Size) ---
        const stations = [
            { id: 1, name: "那霸機場", jp: "那覇空港", active: true },
            { id: 2, name: "赤嶺", jp: "赤嶺", active: false },
            { id: 3, name: "小祿", jp: "小禄", active: false },
            { id: 4, name: "奧武山公園", jp: "奥武山公園", active: false },
            { id: 5, name: "壺川", jp: "壺川", active: false },
            { id: 6, name: "旭橋", jp: "旭橋", active: true, tag: "住宿" },
            { id: 7, name: "縣廳前", jp: "県庁前", active: true },
            { id: 8, name: "美榮橋", jp: "美栄橋", active: false },
            { id: 9, name: "牧志", jp: "牧志", active: true, tag: "集合點" },
            { id: 10, name: "安里", jp: "安里", active: false },
            { id: 11, name: "歌町 (Omoromachi)", jp: "おもろまち", active: true },
            { id: 12, name: "古島", jp: "古島", active: false },
            { id: 13, name: "市立醫院前", jp: "市立病院前", active: false },
            { id: 14, name: "儀保", jp: "儀保", active: true },
            { id: 15, name: "首里", jp: "首里", active: true },
            { id: 16, name: "石嶺", jp: "石嶺", active: false },
            { id: 17, name: "經塚", jp: "経塚", active: false },
            { id: 18, name: "浦添前田", jp: "浦添前田", active: false },
            { id: 19, name: "日子浦西", jp: "てだこ浦西", active: false }
        ];

        function renderStations() {
            const container = document.getElementById('monorail-stations');
            let html = '';
            stations.forEach(st => {
                const opacity = st.active ? 'opacity-100' : 'opacity-40 grayscale';
                const dotClass = st.active ? 'bg-white border-4 border-monorail text-slate-700' : 'bg-white border-4 border-slate-300';
                
                html += `
                    <div class="flex items-center mb-6 relative z-10 ${opacity}">
                        <div class="${dotClass} w-8 h-8 text-xs rounded-full flex items-center justify-center font-bold transition-all shadow-sm flex-shrink-0">
                            ${st.id}
                        </div>
                        <div class="ml-4 flex-1">
                            <div class="flex items-center gap-2">
                                <div class="font-bold text-slate-800 text-sm">${st.name}</div>
                                ${st.tag ? `<span class="text-[10px] bg-red-100 text-red-600 px-1.5 rounded font-bold">${st.tag}</span>` : ''}
                            </div>
                            <div class="text-[10px] text-slate-400 font-mono">${st.jp}</div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // --- Itinerary Data ---
        const itineraryData = [
            {
                day: 1, date: "2/24 (二)", title: "那霸抵達 & 漫遊", 
                events: [
                    { time: "12:30", content: "抵達那霸機場", note: "領行李，搭單軌至旭橋", type: "transport" },
                    { time: "14:15", content: "Check-in", note: "旭橋托里菲托，放行李", type: "stay" },
                    { time: "14:30", content: "傑克牛排 Jack's Steak", note: "走路即達，建議點S號", link: "Jack's Steak House", type: "food" },
                    { time: "15:40", content: "波上宮 & 海灘", note: "拍斷崖神社，步行約10分", link: "Naminoue Shrine", type: "spot" },
                    { time: "16:40", content: "壺屋通 Yachimun", note: "建議計程車，逛陶藝老街", link: "Tsuboya Yachimun Street", type: "spot" },
                    { time: "17:30", content: "EIBUN 沖繩麵", note: "人氣文青麵店", link: "Okinawa Soba EIBUN", type: "food" },
                    { time: "19:00", content: "國際通散步", note: "散步回飯店", type: "walk" }
                ]
            },
            {
                day: 2, date: "2/25 (三)", title: "北部一日遊", notice: "08:00 牧志公園前集合！",
                events: [
                    { time: "08:00", content: "牧志公園前集合", note: "KKday 巴士一日遊", highlight: true, type: "transport" },
                    { time: "09:20", content: "萬座毛", note: "象鼻岩，停留30分", link: "Manzamo", type: "spot" },
                    { time: "10:50", content: "古宇利島", note: "心型岩，停留30分", link: "Kouri Island", type: "spot" },
                    { time: "11:40", content: "美麗海水族館", note: "午餐自理，停留4hr", link: "Okinawa Churaumi Aquarium", type: "spot" },
                    { time: "13:40", content: "備瀨福木林道", note: "綠色隧道", link: "Bise Fukugi Tree Road", type: "spot" },
                    { time: "14:40", content: "Cafe CAHAYA BULAN", note: "海景咖啡", link: "Cafe CAHAYA BULAN", type: "food" },
                    { time: "16:30", content: "美國村 (脫隊)", note: "拿行李下車，不回那霸", highlight: true, link: "American Village Okinawa", type: "spot" },
                    { time: "19:00", content: "搭公車回那霸", note: "桑江站搭120/28 (約1hr)", type: "transport" },
                    { time: "20:00", content: "Nagiji 地酒料理", note: "晚餐", link: "Nagiji Okinawa", type: "food" }
                ]
            },
            {
                day: 3, date: "2/26 (四)", title: "南部 & Outlet", 
                events: [
                    { time: "09:30", content: "沖繩世界 (玉泉洞)", note: "旭橋搭54號公車 (8:40發)", link: "Okinawa World", type: "spot" },
                    { time: "12:00", content: "前往瀨長島", note: "建議計程車約¥4500", highlight: true, type: "transport" },
                    { time: "12:30", content: "瀨長島 (美食)", note: "幸福鬆餅、鮪魚丼、塔可飯", link: "Umikaji Terrace Senagajima", type: "food" },
                    { time: "15:00", content: "前往 Outlet", note: "TK02接駁車", type: "transport" },
                    { time: "15:10", content: "Ashibinaa Outlet", note: "精品", link: "Ashibinaa Outlet", type: "shop" },
                    { time: "16:10", content: "Sports Depo", note: "體育用品", link: "Sports Depo Toyosaki", type: "shop" },
                    { time: "17:00", content: "回那霸市區", note: "89號公車", type: "transport" },
                    { time: "18:30", content: "Shimabutaya", note: "阿古豬炸豬排", link: "Shimabutaya Kumoji", type: "food" }
                ]
            },
            {
                day: 4, date: "2/27 (五)", title: "甜點與海景", 
                events: [
                    { time: "10:00", content: "達磨寺 (西來院)", note: "祈求幸運", link: "Daruma Temple Naha", type: "spot" },
                    { time: "11:30", content: "港川外人住宅", note: "oHacorte、TangTang、可麗露", link: "Minatogawa Stateside Town", type: "spot" },
                    { time: "14:00", content: "PARCO CITY", note: "海景百貨，計程車前往", link: "SAN-A Naha Main Place", type: "shop" },
                    { time: "18:40", content: "燒肉 Buchi", note: "回市區吃燒肉", link: "Yakiniku Buchi Kumoji", type: "food" }
                ]
            },
            {
                day: 5, date: "2/28 (六)", title: "機場最後衝刺", 
                events: [
                    { time: "10:30", content: "那霸機場", note: "國際線3F掛行李", type: "transport" },
                    { time: "11:10", content: "豬肉蛋飯糰", note: "國內線1F", link: "Pork Tamago Onigiri Naha Airport", type: "food" },
                    { time: "11:40", content: "伴手禮採購", note: "紅芋塔、蝦餅", type: "shop" },
                    { time: "13:30", content: "搭機返台 IT289", note: "Safe flight!", highlight: true, type: "transport" }
                ]
            }
        ];

        // --- Deep Guide Data ---
        const guideData = [
            { id: 'jack', title: "傑克牛排 (Jack's Steak)", tags: ['food'], type: '美食', icon: 'fa-utensils', color: 'text-red-500', bg: 'bg-red-50', desc: "1953年開業，美軍認證 A Sign 老店。店外紅綠燈號顯示空位。", tips: "必點 Tenderloin Steak (S號)，No.1 醬汁偏酸建議先吃原味。" },
            { id: 'nami', title: "波上宮", tags: ['spot'], type: '景點', icon: 'fa-torii-gate', color: 'text-orange-500', bg: 'bg-orange-50', desc: "琉球八社之首，建在懸崖上的神社，紅瓦屋頂超美。", tips: "最佳拍攝點在旁邊的波之上橋。" },
            { id: 'yachimun', title: "壺屋通", tags: ['spot','shop'], type: '景點', icon: 'fa-wine-bottle', color: 'text-amber-600', bg: 'bg-amber-50', desc: "陶藝老街，石板路很有氣氛，適合散步。", tips: "路口大獅子是地標。" },
            { id: 'eibun', title: "EIBUN 沖繩麵", tags: ['food'], type: '美食', icon: 'fa-bowl-food', color: 'text-yellow-600', bg: 'bg-yellow-50', desc: "文青風格麵店，湯頭清爽層次豐富。", tips: "若排隊太長可去附近的二號店 STAND EIBUN。" },
            { id: 'manza', title: "萬座毛", tags: ['spot'], type: '景點', icon: 'fa-water', color: 'text-blue-500', bg: 'bg-blue-50', desc: "象鼻岩懸崖，琉球國王曾讚嘆可坐萬人。", tips: "海風非常大，早上順光。" },
            { id: 'kouri', title: "古宇利島", tags: ['spot'], type: '景點', icon: 'fa-heart', color: 'text-pink-500', bg: 'bg-pink-50', desc: "戀之島，必看雙心型岩與跨海大橋。", tips: "Arashi 廣告拍攝地。" },
            { id: 'chura', title: "美麗海水族館", tags: ['spot'], type: '景點', icon: 'fa-fish', color: 'text-cyan-500', bg: 'bg-cyan-50', desc: "黑潮之海大水槽，看鯨鯊與鬼蝠魟。", tips: "鯨鯊餵食秀 15:00 / 17:00。" },
            { id: 'bise', title: "備瀨福木林道", tags: ['spot'], type: '景點', icon: 'fa-tree', color: 'text-green-600', bg: 'bg-green-50', desc: "防風林綠色隧道，光影很美。", tips: "蚊蟲多請噴防蚊液。" },
            { id: 'american', title: "美國村", tags: ['spot','shop'], type: '購物', icon: 'fa-star', color: 'text-purple-500', bg: 'bg-purple-50', desc: "美式風格聚落，日落與夜景迷人。", tips: "Magic Hour 夕陽必看。" },
            { id: 'nagiji', title: "Nagiji (那吉次)", tags: ['food'], type: '美食', icon: 'fa-glass-cheers', color: 'text-indigo-600', bg: 'bg-indigo-50', desc: "在地料理與泡盛，氣氛佳。", tips: "建議預約。" },
            { id: 'world', title: "沖繩世界 (玉泉洞)", tags: ['spot'], type: '景點', icon: 'fa-dungeon', color: 'text-slate-600', bg: 'bg-slate-100', desc: "日本第二大鐘乳石洞，壯觀涼爽。", tips: "地板濕滑請小心。" },
            { id: 'senaga', title: "瀨長島", tags: ['spot','food'], type: '景點', icon: 'fa-plane-arrival', color: 'text-sky-500', bg: 'bg-sky-50', desc: "希臘風白色建築，看飛機起降。", tips: "幸福鬆餅、Taco Rice Cafe Kijimuna、親父のまぐろ (鮪魚丼) 必吃。" },
            { id: 'outlet', title: "Ashibinaa Outlet", tags: ['shop'], type: '購物', icon: 'fa-shopping-bag', color: 'text-pink-600', bg: 'bg-pink-50', desc: "精品與運動品牌 Outlet。", tips: "先去 Information 拿 Coupon。" },
            { id: 'depo', title: "Sports Depo", tags: ['shop'], type: '購物', icon: 'fa-basketball-ball', color: 'text-blue-600', bg: 'bg-blue-50', desc: "超大體育用品店，就在 Outlet 對面。", tips: "棒球、露營用品很全。" },
            { id: 'agu', title: "Shimabutaya", tags: ['food'], type: '美食', icon: 'fa-bacon', color: 'text-orange-600', bg: 'bg-orange-50', desc: "阿古豬炸豬排專賣，肉甜多汁。", tips: "沾鹽吃最美味。" },
            { id: 'daruma', title: "達磨寺", tags: ['spot'], type: '景點', icon: 'fa-vihara', color: 'text-red-600', bg: 'bg-red-50', desc: "祈求幸運與合格的寺廟。", tips: "有很多達磨像。" },
            { id: 'mina', title: "港川外人住宅", tags: ['spot','food'], type: '美食', icon: 'fa-home', color: 'text-teal-500', bg: 'bg-teal-50', desc: "美軍眷村改建，文青小店聚集。", tips: "oHacorte (18號)、TangTang肉饅、Houki Boshi可麗露、Cocoroar CAFE。" },
            { id: 'parco', title: "PARCO CITY", tags: ['shop'], type: '購物', icon: 'fa-building', color: 'text-gray-600', bg: 'bg-gray-50', desc: "無敵海景百貨。", tips: "2F 美食街海景座位超棒。" },
            { id: 'buchi', title: "燒肉 Buchi", tags: ['food'], type: '美食', icon: 'fa-drumstick-bite', color: 'text-red-700', bg: 'bg-red-100', desc: "高品質燒肉，離旭橋近。", tips: "牛舌必點。" },
            { id: 'onigiri', title: "豬肉蛋飯糰", tags: ['food'], type: '美食', icon: 'fa-rice-cracker', color: 'text-yellow-500', bg: 'bg-yellow-100', desc: "沖繩靈魂美食。", tips: "機場店人多可買炸蝦口味帶上機。" }
        ];

        // --- Functions ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(el => {
                if(el.dataset.target === tabId) {
                    el.classList.add('text-deep-sea', 'bg-slate-50');
                    el.classList.remove('text-slate-400');
                } else {
                    el.classList.remove('text-deep-sea', 'bg-slate-50');
                    el.classList.add('text-slate-400');
                }
            });
            window.scrollTo(0, 0);
        }

        // Japanese Phrase Tabs Logic
        function switchPhraseTab(category) {
            // Hide all phrase groups
            document.querySelectorAll('.phrase-group').forEach(el => el.classList.remove('active'));
            // Show selected group
            document.getElementById(`phrases-${category}`).classList.add('active');
            
            // Update Tab Styles
            const tabs = ['basic', 'dining', 'shopping', 'traffic'];
            tabs.forEach(tab => {
                const btn = document.getElementById(`tab-${tab}`);
                if (tab === category) {
                    btn.className = "flex-1 py-2 font-bold text-indigo-600 border-b-2 border-indigo-500 bg-white transition-all";
                } else {
                    btn.className = "flex-1 py-2 text-slate-500 border-b-2 border-transparent hover:text-slate-700 transition-all";
                }
            });
        }

        function speakJapanese(text) {
            if ('speechSynthesis' in window) {
                const msg = new SpeechSynthesisUtterance(text);
                msg.lang = 'ja-JP';
                window.speechSynthesis.speak(msg);
            } else {
                alert("您的裝置不支援語音朗讀");
            }
        }

        function renderItinerary() {
            const container = document.getElementById('itinerary-container');
            let html = '';
            itineraryData.forEach(day => {
                let eventsHtml = '';
                day.events.forEach(event => {
                    const highlightClass = event.highlight ? 'bg-orange-50 border-orange-200' : 'bg-white border-slate-100';
                    const timeColor = event.highlight ? 'text-sunset font-bold' : 'text-slate-400';
                    const icon = getIconByType(event.type);
                    let linkHtml = '';
                    if(event.link) {
                        const query = encodeURIComponent(event.link);
                        linkHtml = `<a href="https://www.google.com/maps/search/?api=1&query=${query}" target="_blank" class="ml-2 text-ocean w-6 h-6 flex items-center justify-center"><i class="fas fa-location-arrow"></i></a>`;
                    }
                    eventsHtml += `
                        <div class="flex relative pb-6 last:pb-0">
                            <div class="flex-shrink-0 w-12 text-xs font-mono font-medium ${timeColor} pt-1.5">${event.time}</div>
                            <div class="flex-grow pl-4 border-l-2 border-slate-200 relative">
                                <div class="absolute -left-[5px] top-2 w-2.5 h-2.5 rounded-full ${event.highlight ? 'bg-sunset ring-2 ring-orange-100' : 'bg-slate-300'}"></div>
                                <div class="p-3 rounded-xl border shadow-sm ${highlightClass}">
                                    <div class="font-bold text-slate-700 flex justify-between items-start text-sm">
                                        <span class="flex-1 leading-tight">${icon} ${event.content}</span>
                                        ${linkHtml}
                                    </div>
                                    <div class="text-xs text-slate-500 mt-1.5 leading-relaxed">${event.note}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += `
                    <div class="bg-white/90 rounded-2xl p-4 shadow-sm backdrop-blur-sm border border-white mb-4">
                        <div class="sticky top-16 bg-white/95 backdrop-blur z-10 py-3 border-b border-slate-100 mb-4 flex justify-between items-center -mx-2 px-2 rounded-t-xl">
                            <h3 class="font-bold text-deep-sea text-lg">Day ${day.day} <span class="text-sm font-normal text-slate-500 ml-2 font-mono">${day.date}</span></h3>
                            ${day.title ? `<span class="text-[10px] bg-deep-sea text-white px-2 py-1 rounded-full shadow-sm">${day.title}</span>` : ''}
                        </div>
                        ${day.notice ? `<div class="bg-yellow-50 text-yellow-700 text-xs p-3 rounded-lg mb-4 flex items-start border border-yellow-100"><i class="fas fa-bullhorn mr-2 mt-0.5"></i> <span>${day.notice}</span></div>` : ''}
                        <div class="space-y-1">${eventsHtml}</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function getIconByType(type) {
            const map = { transport: '<i class="fas fa-bus text-slate-400 mr-1"></i>', food: '<i class="fas fa-utensils text-yellow-500 mr-1"></i>', spot: '<i class="fas fa-camera text-ocean mr-1"></i>', stay: '<i class="fas fa-bed text-purple-500 mr-1"></i>', shop: '<i class="fas fa-shopping-bag text-pink-500 mr-1"></i>', walk: '<i class="fas fa-walking text-green-500 mr-1"></i>' };
            return map[type] || '';
        }

        function renderGuide(filter = 'all') {
            const container = document.getElementById('guide-container');
            let html = '';
            const filteredData = filter === 'all' ? guideData : guideData.filter(item => item.tags.includes(filter));
            filteredData.forEach(item => {
                html += `
                    <div class="bg-white rounded-2xl shadow-sm p-4 border border-slate-100 flex gap-4 items-start">
                        <div class="${item.bg} ${item.color} w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center text-lg shadow-sm">
                            <i class="fas ${item.icon}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start mb-1">
                                <h3 class="font-bold text-slate-800 text-sm">${item.title}</h3>
                                <span class="text-[10px] text-slate-400 border px-1 rounded">${item.type}</span>
                            </div>
                            <p class="text-xs text-slate-600 mb-2 leading-relaxed text-justify">${item.desc}</p>
                            <div class="text-[10px] bg-slate-50 text-slate-500 p-2 rounded-lg border border-slate-100">
                                <i class="fas fa-lightbulb text-yellow-400 mr-1"></i> ${item.tips}
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function filterGuide(type) {
            document.querySelectorAll('.guide-filter').forEach(btn => {
                const isActive = btn.innerText === (type === 'all' ? '全部' : (type === 'food' ? '在地美食' : (type === 'spot' ? '必訪景點' : '購物血拼')));
                btn.className = isActive ? 'guide-filter active px-4 py-1.5 rounded-full text-sm font-medium bg-deep-sea text-white shadow-sm whitespace-nowrap transition-all' : 'guide-filter px-4 py-1.5 rounded-full text-sm font-medium bg-white text-slate-600 border border-slate-200 whitespace-nowrap transition-all';
            });
            renderGuide(type);
        }

        // Wallet
        let expenses = JSON.parse(localStorage.getItem('okinawa_expenses')) || [];
        let totalBudget = parseFloat(localStorage.getItem('okinawa_budget')) || 150000;

        // FIXED: Toggle Input instead of Prompt
        function toggleBudgetInput() {
            const box = document.getElementById('budget-input-box');
            box.classList.toggle('hidden');
            if(!box.classList.contains('hidden')) {
                document.getElementById('new-budget-input').value = totalBudget;
                document.getElementById('new-budget-input').focus();
            }
        }

        function saveNewBudget() {
            const input = document.getElementById('new-budget-input');
            const val = parseFloat(input.value);
            if(!isNaN(val) && val > 0) {
                totalBudget = val;
                localStorage.setItem('okinawa_budget', totalBudget);
                renderExpenses();
                toggleBudgetInput(); // Hide the input box
            } else {
                alert("請輸入有效的金額");
            }
        }

        function addExpense() {
            const item = document.getElementById('expense-item').value;
            const amount = document.getElementById('expense-amount').value;
            const payer = document.getElementById('expense-payer').value;
            if(!item || !amount) { alert("請輸入項目與金額"); return; }
            expenses.unshift({ id: Date.now(), item, amount: parseFloat(amount), payer, date: new Date().toLocaleDateString(undefined, {month:'numeric', day:'numeric'}) });
            localStorage.setItem('okinawa_expenses', JSON.stringify(expenses));
            document.getElementById('expense-item').value = '';
            document.getElementById('expense-amount').value = '';
            renderExpenses();
            const toast = document.getElementById('toast');
            toast.classList.remove('opacity-0', 'translate-y-4');
            setTimeout(() => toast.classList.add('opacity-0', 'translate-y-4'), 2000);
        }
        
        function getExpenseIcon(name) {
            // Simple keyword matching
            if (name.includes('麵') || name.includes('飯') || name.includes('餐') || name.includes('食') || name.includes('肉') || name.includes('酒') || name.includes('咖啡')) return '<i class="fas fa-utensils"></i>';
            if (name.includes('車') || name.includes('票') || name.includes('卡')) return '<i class="fas fa-bus"></i>';
            if (name.includes('門票') || name.includes('館')) return '<i class="fas fa-ticket-alt"></i>';
            if (name.includes('藥') || name.includes('妝')) return '<i class="fas fa-pump-soap"></i>';
            if (name.includes('衣') || name.includes('鞋') || name.includes('包')) return '<i class="fas fa-tshirt"></i>';
            return '<i class="fas fa-shopping-bag"></i>';
        }

        function renderExpenses() {
            const container = document.getElementById('expense-list');
            const rate = parseFloat(document.getElementById('exchange-rate').value);
            let totalJPY = 0;
            let html = '';
            expenses.forEach(exp => {
                totalJPY += exp.amount;
                const twd = Math.round(exp.amount * rate);
                let payerColor = exp.payer === '公費' ? 'bg-purple-100 text-purple-600' : (exp.payer === '自己' ? 'bg-blue-100 text-blue-600' : 'bg-slate-100 text-slate-500');
                const icon = getExpenseIcon(exp.item);
                
                html += `
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-ocean flex items-center justify-between group transition-all active:scale-[0.98]">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center text-lg">
                                ${icon}
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-700 text-sm">${exp.item}</h4>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-[10px] px-2 py-0.5 rounded-full ${payerColor}">${exp.payer}</span>
                                    <span class="text-[10px] text-slate-400">${exp.date}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="text-right">
                                <div class="font-mono font-bold text-lg text-slate-800">¥${exp.amount.toLocaleString()}</div>
                                <div class="text-[10px] text-slate-400">≈ NT$${twd.toLocaleString()}</div>
                            </div>
                            <button onclick="deleteExpense(${exp.id})" class="text-slate-300 hover:text-red-400 px-2 transition-colors"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                `;
            });
            if(expenses.length === 0) html = '<div class="text-center text-slate-400 py-10 text-sm border border-dashed rounded-xl bg-slate-50">尚未有消費紀錄</div>';
            container.innerHTML = html;
            document.getElementById('total-spent-jpy').innerText = totalJPY.toLocaleString();
            document.getElementById('budget-left').innerText = (totalBudget - totalJPY).toLocaleString();
            document.getElementById('budget-bar').style.width = `${Math.min(100, (totalJPY / totalBudget) * 100)}%`;
        }
        
        function deleteExpense(id) {
            if(confirm("確定刪除此筆消費？")) {
                expenses = expenses.filter(e => e.id !== id);
                localStorage.setItem('okinawa_expenses', JSON.stringify(expenses));
                renderExpenses();
            }
        }

        function calculateCurrency() {
            const input = document.getElementById('calc-input').value;
            const rate = parseFloat(document.getElementById('exchange-rate').value);
            try {
                const jpy = eval(input);
                const twd = Math.round(jpy * rate);
                const el = document.getElementById('calc-result');
                el.innerText = `= ¥${jpy} ≈ NT$${twd}`;
                el.classList.remove('opacity-0');
            } catch (e) {}
        }
        
        // Tax Free Calc (Japan 10%)
        function calcTax() {
            const price = parseFloat(document.getElementById('tax-input').value);
            if (!isNaN(price)) {
                // Formula: Price / 1.1 = Net Price. Refund = Price - Net.
                const netPrice = price / 1.1;
                const refund = Math.floor(price - netPrice); // Floor or Round depending on shop policy, usually drop fractions.
                const finalPrice = Math.ceil(netPrice);
                
                document.getElementById('refund-amount').innerText = refund.toLocaleString();
                document.getElementById('tax-result').innerText = finalPrice.toLocaleString();
            } else {
                document.getElementById('refund-amount').innerText = "0";
                document.getElementById('tax-result').innerText = "0";
            }
        }

        function copyAddress() {
            navigator.clipboard.writeText("〒900-0021 沖縄県那覇市泉崎1-11-19");
            alert("地址已複製");
        }

        // Tools
        const memoArea = document.getElementById('memo-area');
        memoArea.value = localStorage.getItem('okinawa_memo') || '';
        memoArea.addEventListener('input', function() { localStorage.setItem('okinawa_memo', this.value); });
        
        function exportData() {
            const data = { expenses, memo: memoArea.value, budget: totalBudget };
            const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = "okinawa2026_backup.json"; a.click();
        }
        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.expenses) localStorage.setItem('okinawa_expenses', JSON.stringify(data.expenses));
                    if(data.memo) localStorage.setItem('okinawa_memo', data.memo);
                    if(data.budget) localStorage.setItem('okinawa_budget', data.budget);
                    location.reload();
                } catch(err) { alert("格式錯誤"); }
            };
            reader.readAsText(file);
        }

        // Init
        window.onload = function() {
            renderStations(); renderItinerary(); renderGuide('all'); renderExpenses();
            // Countdown
            const tripDate = new Date('2026-02-24T00:00:00').getTime();
            const now = new Date().getTime();
            const diff = Math.ceil((tripDate - now) / (1000 * 60 * 60 * 24));
            document.getElementById('countdown-text').innerText = diff > 0 ? `${diff} DAYS` : "Enjoy Trip!";
        }
    </script>
</body>
</html>